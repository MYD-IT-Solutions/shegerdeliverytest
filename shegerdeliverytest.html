<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheger Deliveries - Test Execution Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .form-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            background-color: white;
        }

        .form-section-header {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .test-case-row {
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .test-case-row:last-child {
            border-bottom: none;
        }

        .test-case-button {
            text-align: left;
            transition: background-color 0.2s ease;
        }

        .test-case-button:hover {
            background-color: #f9fafb;
        }

        .expected-result {
            border-left: 4px solid #10b981;
            background-color: #f0fdf4;
            padding: 0.75rem 1rem;
            margin-top: 1rem;
        }

        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }

        .modal-container {
            transition: transform 0.3s ease;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <form id="test-form">
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">

            <!-- Form Header -->
            <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Sheger Deliveries - Test Execution</h1>
                <p class="text-gray-600 mt-2">Please fill out this form for each testing session. Mark the status of
                    each test case and provide comments for any 'Fail' or 'Blocked' results.</p>
            </div>

            <!-- Tester Information Section -->
            <div class="form-section shadow-sm">
                <div class="form-section-header">
                    <h2 class="text-xl font-semibold">Tester Information</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="tester_name" class="block text-sm font-medium text-gray-700 mb-1">Tester
                            Name</label>
                        <input type="text" id="tester_name" name="tester_name"
                            class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required>
                    </div>
                    <div>
                        <label for="test_date" class="block text-sm font-medium text-gray-700 mb-1">Date of
                            Testing</label>
                        <input type="text" id="test_date" name="test_date"
                            class="w-full p-2 border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                </div>
            </div>

            <!-- Web Application Sections -->
            <div class="form-section shadow-sm">
                <div class="form-section-header">
                    <h2 class="text-2xl font-bold">2. Web Application</h2>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">2.1 Common Pages</h3>
                <div id="web-common-pages"></div>
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">2.2 Customer Portal</h3>
                <div id="web-customer-portal"></div>
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">2.3 Store Portal</h3>
                <div id="web-store-portal"></div>
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">2.4 Provider Portal</h3>
                <div id="web-provider-portal"></div>
            </div>

            <!-- Mobile Application Sections -->
            <div class="form-section shadow-sm">
                <div class="form-section-header">
                    <h2 class="text-2xl font-bold">3. Mobile Application</h2>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">3.1 Customer Application</h3>
                <div id="mobile-customer-app"></div>
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">3.2 Store Application</h3>
                <div id="mobile-store-app"></div>
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">3.3 Driver Application</h3>
                <div id="mobile-driver-app"></div>
            </div>

            <button type="submit"
                class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md">Submit
                Test Results</button>
        </div>
    </form>

    <!-- Test Case Detail Modal -->
    <div id="test-case-modal"
        class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal-overlay hidden opacity-0">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col modal-container transform scale-95">
            <div class="p-5 border-b border-gray-200 bg-gray-50">
                <h2 id="modal-title" class="text-xl font-bold text-gray-900"></h2>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <h3 class="font-semibold text-lg mb-2 text-gray-800">Test Scenario</h3>
                <p id="modal-scenario" class="mb-4 text-gray-600"></p>
                <h3 class="font-semibold text-lg mb-2 text-gray-800">Test Steps</h3>
                <ol id="modal-steps" class="list-decimal list-inside space-y-2 mb-4 text-gray-600"></ol>
                <h3 class="font-semibold text-lg mb-2 text-gray-800">Expected Result</h3>
                <div id="modal-expected-result" class="expected-result text-gray-700"></div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 text-right">
                <button id="close-test-case-modal-btn"
                    class="bg-gray-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-700 transition-colors">Close</button>
            </div>
        </div>
    </div>


    <!-- Results Modal -->
    <div id="results-modal"
        class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal-overlay hidden opacity-0">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col modal-container transform scale-95">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold">Test Execution Summary</h2>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <h3 class="font-semibold text-lg mb-2">Tester Info:</h3>
                <p id="modal-tester-info" class="mb-4 p-3 bg-gray-100 rounded-md"></p>
                <h3 class="font-semibold text-lg mb-2">Results (JSON):</h3>
                <p class="text-sm text-gray-600 mb-2">You can copy the text below and paste it into a JSON viewer or a
                    spreadsheet.</p>
                <textarea id="modal-results-json"
                    class="w-full h-64 p-3 border border-gray-300 rounded-md font-mono text-sm bg-gray-50"
                    readonly></textarea>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                <button id="export-json-btn"
                    class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors">Export
                    JSON</button>
                <button id="close-modal-btn"
                    class="bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <script>
        const allTestCases = {};

        // Function to create a test case row in the HTML
        function createTestCase(tc) {
            allTestCases[tc.id] = tc; // Store full test case data for later use
            const buttonData = `data-id="${tc.id}"`;
            return `
            <div class="test-case-row grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                <div class="md:col-span-5">
                    <button type="button" class="w-full p-2 rounded-md test-case-button" onclick="showTestCaseDetails(this)" ${buttonData}>
                        <p class="font-semibold text-gray-800">${tc.id}</p>
                        <p class="text-sm text-gray-600">${tc.scenario}</p>
                    </button>
                </div>
                <div class="md:col-span-3">
                    <select name="${tc.id}_status" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="Not Tested" selected>Not Tested</option>
                        <option value="Pass">Pass</option>
                        <option value="Fail">Fail</option>
                        <option value="Blocked">Blocked</option>
                    </select>
                </div>
                <div class="md:col-span-4">
                    <input type="text" name="${tc.id}_comment" placeholder="Comments (Required for Fail/Blocked)" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
            `;
        }

        // Function to show the test case details modal
        window.showTestCaseDetails = function (button) {
            const id = button.getAttribute('data-id');
            const tc = allTestCases[id];

            if (!tc) return;

            document.getElementById('modal-title').textContent = `${tc.id} - ${tc.feature}`;
            document.getElementById('modal-scenario').textContent = tc.scenario;
            document.getElementById('modal-expected-result').textContent = tc.expected_result;

            const stepsList = document.getElementById('modal-steps');
            stepsList.innerHTML = '';
            // FIX: Remove the number from the beginning of the step string
            tc.steps.split('\n').forEach(step => {
                const li = document.createElement('li');
                const cleanStep = step.replace(/^\d+\.\s*/, ''); // Removes "1. ", "2. ", etc.
                li.innerHTML = cleanStep.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-indigo-600 hover:underline">$1</a>');
                stepsList.appendChild(li);
            });

            const testCaseModal = document.getElementById('test-case-modal');
            testCaseModal.classList.remove('hidden');
            setTimeout(() => testCaseModal.classList.remove('opacity-0'), 10);
            setTimeout(() => testCaseModal.querySelector('.modal-container').classList.remove('scale-95'), 10);
        }

        // Main script execution
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date automatically
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            document.getElementById('test_date').value = formattedDate;

            // Fetch data and populate the form
            fetch('testcase.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const containers = {
                        'web-common-pages': [...data.web_application.common_pages.landing_page, ...data.web_application.common_pages.login_registration],
                        'web-customer-portal': [...data.web_application.customer_portal.user_profile, ...data.web_application.customer_portal.store_listing, ...data.web_application.customer_portal.store_detail, ...data.web_application.customer_portal.checkout, ...data.web_application.customer_portal.order_tracking],
                        'web-store-portal': [...data.web_application.store_portal.dashboard, ...data.web_application.store_portal.payouts, ...data.web_application.store_portal.menu, ...data.web_application.store_portal.offers, ...data.web_application.store_portal.preparation_time, ...data.web_application.store_portal.orders],
                        'web-provider-portal': [...data.web_application.provider_portal.profile, ...data.web_application.provider_portal.orders],
                        'mobile-customer-app': [...data.mobile_application.customer_application.login_registration, ...data.mobile_application.customer_application.service_selection, ...data.mobile_application.customer_application.side_navigation, ...data.mobile_application.customer_application.ordering_flow],
                        'mobile-store-app': [...data.mobile_application.store_application.order_management, ...data.mobile_application.store_application.side_navigation],
                        'mobile-driver-app': [...data.mobile_application.driver_application.order_flow, ...data.mobile_application.driver_application.side_navigation],
                    };

                    for (const containerId in containers) {
                        const container = document.getElementById(containerId);
                        if (container) {
                            containers[containerId].forEach(tc => {
                                container.innerHTML += createTestCase(tc);
                            });
                        }
                    }
                })
                .catch(error => console.error('Error loading test cases:', error));


            // Modal and Form Submission Logic
            const form = document.getElementById('test-form');
            const resultsModal = document.getElementById('results-modal');
            const testCaseModal = document.getElementById('test-case-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const closeTestCaseModalBtn = document.getElementById('close-test-case-modal-btn');
            const exportJsonBtn = document.getElementById('export-json-btn');

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(form);
                const results = {
                    testerName: formData.get('tester_name'),
                    testDate: formData.get('test_date'),
                    results: []
                };

                for (const id in allTestCases) {
                    const status = formData.get(`${id}_status`);
                    if (status && status !== 'Not Tested') {
                        results.results.push({
                            id: id,
                            scenario: allTestCases[id].scenario,
                            status: status,
                            comment: formData.get(`${id}_comment`) || ''
                        });
                    }
                }

                document.getElementById('modal-tester-info').textContent = `Tester: ${results.testerName} | Date: ${results.testDate}`;
                document.getElementById('modal-results-json').value = JSON.stringify(results, null, 2);

                resultsModal.classList.remove('hidden');
                setTimeout(() => resultsModal.classList.remove('opacity-0'), 10);
                setTimeout(() => resultsModal.querySelector('.modal-container').classList.remove('scale-95'), 10);
            });

            const closeModal = (modal) => {
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-container').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            closeModalBtn.addEventListener('click', () => closeModal(resultsModal));
            closeTestCaseModalBtn.addEventListener('click', () => closeModal(testCaseModal));

            const exportResults = () => {
                const jsonString = document.getElementById('modal-results-json').value;
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const testerName = document.getElementById('tester_name').value.replace(/ /g, '_') || 'tester';
                const testDate = document.getElementById('test_date').value || 'date';
                a.href = url;
                a.download = `test-results_${testerName}_${testDate}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            exportJsonBtn.addEventListener('click', exportResults);

            resultsModal.addEventListener('click', (e) => {
                if (e.target === resultsModal) closeModal(resultsModal);
            });
            testCaseModal.addEventListener('click', (e) => {
                if (e.target === testCaseModal) closeModal(testCaseModal);
            });
        });
    </script>

</body>

</html>